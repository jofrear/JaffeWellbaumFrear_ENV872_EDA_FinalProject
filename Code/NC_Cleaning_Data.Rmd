---
title: "R Notebook"
output: pdf_document
author: "Cate Jaffe"
editor_options:
  chunk_output_type: console
---
### Setup
```{r setup}
# Library
library(tidyverse)
library(ggplot2)
library(scales)
library(auk) # eBird Package
library(agricolae)
#install.packages("lubridate")
library(lubridate)
library(colormap)
library(ggridges)
library(RColorBrewer)
library(corrplot)

# set wd
knitr::opts_knit$set( root.dir = 
                        "/Users/Kate/Documents/1.Spring 2021/JaffeWellbaumFrear_ENV872_EDA_FinalProject",
                  tidy.opts = list(width.cutoff = 60),
                  tidy = TRUE)
getwd()

# ggplot theme
mytheme <- theme_light( base_size = 14) + 
  theme( axis.text = element_text( color = "#222222ff"),
         legend.position = "top",
         # margins (top,right,bottom,left)
         axis.title.x = element_text( color = "black",
                                    margin = margin(20,0,0,0)),
         axis.title.y = element_text( color = "black",
                                    margin = margin(0,20,0,0)))
theme_set(mytheme)
```

# Import Data
```{r data import}
# import bird data
# eBird data is in text format, package "auk" used to convert to dataframe
woodduck <- read_ebd("./Data/Raw/NorthCarolina/ebd_US-NC_wooduc_relFeb-2021/ebd_US-NC_wooduc_relFeb-2021.txt")
rwbbird <- read_ebd("./Data/Raw/NorthCarolina/ebd_US-NC_rewbla_relMar-2021/ebd_US-NC_rewbla_relMar-2021.txt")
osprey <- read_ebd("./Data/Raw/NorthCarolina/ebd_US-NC_osprey_relFeb-2021/ebd_US-NC_osprey_relFeb-2021.txt")

# import weather data
weather <- read.csv("./Data/Raw/NorthCarolina/NCTemperature20102021.csv") %>% unique()

```

# Data Cleaning
```{r bird data clean}

# create merged dataset of all bird data
allBirds <- bind_rows(woodduck, rwbbird, osprey)

### clean
allBirds <- allBirds %>%
  # filter dates to date range of interest: 2010 - 2021
  filter(year(observation_date) > 2009 & year(observation_date) < 2022) %>%
  # select only columns of interest
  select(common_name:observation_count, state, county,
                                      latitude:time_observations_started, protocol_type,
                                      duration_minutes:number_observers,
                                      all_species_reported) %>% 
    # change "X" value in observation_count to 1 (X represents "present" in eBird)
    # change to numeric variable after converting to X
    mutate(observation_count = as.numeric(replace(observation_count, observation_count == 'X', '1')),
           # add column which divides # observations per minute observation
           # this controls for birding "effort" which was much higher in later years (2015-2020)
           observations_per_min = observation_count/duration_minutes,
           # add column for "month-year" using floor_date from lubridate
           Year_Month = floor_date(observation_date, unit = "month"),
           # add binary presence column
           Presence = 1
    )

# what is the distribution of the new "observations per minute" variable?
summary(allBirds$observations_per_min)

# create version of dataset with Inf and NA values of "observations_per_min" excluded
# made this a separate dataset because rows where the observation duration was missing or 0
# created values of NA and Inf. 
#Removing these NA and Inf values removed about 10,000 observations, or ~6% of the data.
allBirds_obvPerMin <- allBirds %>% 
  filter( is.na(observations_per_min) == FALSE) %>% 
  filter( observations_per_min != Inf)
# check final dataset
summary(allBirds_obvPerMin$observations_per_min)
# looks good, might be some large outliers.


### Create grouped dataset
allBirds_YMgrouped <- 
  allBirds %>%
  group_by(common_name, Year_Month) %>% 
  summarize(state = first(state),
            observation_count_sum = sum(observation_count),
            presence_count = sum(Presence)
            ) 
# observations per minute (OPM)
allBirds_YMgrouped_OPM <- 
  allBirds_obvPerMin %>%
  group_by(common_name, Year_Month) %>% 
  summarize(state = first(state),
            observation_count_sum = sum(observation_count),
            presence_count = sum(Presence),
            observation_per_min_avg = mean(observations_per_min)
            ) 

```

```{r weather data clean}

# group by month & year
weather_YM <- weather %>% 
  # omit NAs
  na.omit() %>% 
  # make Year-Month column
  mutate( Year_Month = ydm((paste0(Year,"-01-",Month)))) %>% 
  group_by(Year_Month) %>% 
  # take statewide average
  summarise(AvgMonthlyTemp_Statewide = mean(AvgMonthlyTemp))

  
```

# Data Exploration
```{r bird exploratory plots}

### Birds, ungrouped
# basic density plot across all years, faceted 
ggplot(allBirds, aes(x = observation_date, fill = common_name, color = common_name)) +
  geom_density(alpha = .2) + 
  facet_wrap(vars(common_name), nrow = 1, ncol = 3) + 
  theme( legend.position = "none",
         axis.text.x = element_text(angle = 45,
                                    hjust = 1)) + 
  # disable scientific notation in y axis
  # set color and fill manually
  scale_color_brewer( palette = "Dark2") + 
  scale_fill_brewer( palette = "Dark2") + 
  # make labels legible
  labs(x = "Observation Date")
#  scale_x_date(limits = c(as.Date("2015-01-01"), as.Date("2015-12-31")))


# as a ridgeplot
ggplot(allBirds, aes(x = observation_date, y = common_name, fill = common_name, color = common_name)) + 
  geom_density_ridges(alpha = .2) + 
  theme(legend.position = "none",
        axis.title.y = element_blank()) + 
  scale_color_brewer( palette = "Dark2") + 
  scale_fill_brewer( palette = "Dark2") + 
  labs(x = "Observation Date",
       title = "Density Plot of Bird Appearences on eBird Checklists",
       subtitle = "2010 - 2020")

# crazy looking ridgeplot for all counties
ggplot(allBirds, aes(x = observation_date, y = county, fill = common_name, color = common_name)) + 
  geom_density_ridges(alpha = .8) + 
  facet_wrap(vars(common_name), nrow = 1, ncol = 3) + 
  theme( axis.text.y = element_text(size = 6))

### Bird Presence (# of times it appeared on checklist), monthly 
# uses grouped data
ggplot(allBirds_YMgrouped, aes(x = Year_Month, y = presence_count, group = common_name, color = common_name)) +
  geom_line(alpha = .8) 

### Bird Presence (corrected for effort), monthly 
# uses grouped data
ggplot(allBirds_YMgrouped_OPM, aes(x = Year_Month, y = observation_per_min_avg, group = common_name, color = common_name)) +
  geom_line(alpha = .8) + 
  facet_wrap(vars(common_name), nrow = 1, ncol = 3) + 
  theme( legend.position = "none",
         axis.text.x = element_text(angle = 45,
                                    hjust = 1)) + 
  # disable scientific notation in y axis
  # set color and fill manually
  scale_color_brewer( palette = "Dark2") + 
  scale_fill_brewer( palette = "Dark2") + 
  # make labels legible
  labs(x = "Observation Date") + 
  scale_y_log10()

```

```{r temperature exploratory plots}

# Temperature trend distributions by year, ungrouped
ggplot(weather, aes(x = AvgMonthlyTemp, y = as.factor(Year))) +
  geom_density_ridges(alpha = .8, fill = "lightblue")
  # Note incomplete data for 2021.

# Temperature trends by year-month groups
ggplot(weather_YM, aes(x = Year_Month, y = AvgMonthlyTemp_Statewide, color = AvgMonthlyTemp_Statewide)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .8) + 
  scale_x_date(breaks = "6 months",
                date_labels = "%b %Y") + 
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) + 
  scale_color_colormap(colormap = "temperature") + 
  theme(legend.position = "none")
  # Note incomplete data for 2021. 


```

```{r join temp and bird data}

birdsWeather_YM <- full_join(allBirds_YMgrouped, weather_YM, 
                             by = "Year_Month") %>% 
  mutate(Month = month(Year_Month),
         Year = year(Year_Month))

# with Observations per minute variable
birdsWeather_YM_OPM <- full_join(allBirds_YMgrouped_OPM, weather_YM, 
                             by = "Year_Month") %>% 
  mutate(Month = month(Year_Month),
         Year = year(Year_Month))

```

### Analysis: Bird Observations & Temperature

```{r Plots}

#  observations per minute to overtime, by temperature
ggplot(birdsWeather_YM_OPM, aes(x = Year_Month,
                            y = log10(observation_per_min_avg))) + 
  geom_line(lwd = .8) + 
  facet_wrap(vars(common_name), nrow = 3, scale = "free") + 
  theme(legend.position = "bottom") + 
#  scale_y_log10() + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") + 
  labs(y = "Average Observations per Minute of Observation (log10)",
       x = "Year",
       title = "Bird Observations in North Carolina",
       subtitle = "2010 - 2020")

#  observations per minute over months,  color by temperature, facet by year
ggplot(birdsWeather_YM_OPM, aes(x = as.factor(Month),
                            y = observation_per_min_avg,
                            color = AvgMonthlyTemp_Statewide)) + 
  geom_line() + 
  scale_color_colormap(colormap = "temperature") +
  facet_wrap(vars(common_name) ~ vars(as.factor(Year)) ) + 
  theme(legend.position = "bottom") + 
  scale_y_log10() + 
  labs(y = "Average Observations per Minute of Observation (log10)",
       x = "Year",
       color = "Average Monthly\nTemperature (F):",
       title = "Bird Observations in NC 2010 - 2020 by \nAverage Monthly Temperature (F)")
  
# with temperature as x axis and Year as color blocks
#  observations per minute to overtime, by temperature
ggplot(birdsWeather_YM_OPM %>% filter(Year != 2021),
       aes(x = AvgMonthlyTemp_Statewide,
           y = observation_per_min_avg,
           color = AvgMonthlyTemp_Statewide) ) + 
  geom_point(alpha = .7) +
  scale_color_brewer() + 
 # scale_color_colormap(colormap = "temperature") +
  # facet
  facet_wrap(vars(common_name)) + 
  # remove legend
  theme(legend.position = "bottom") + 
  # log10 scale
  scale_y_log10() + 
  # labels
  labs(y = "Average Observations per Minute of Observation (log10)",
       x = "Average Monthly Temperature",
       color = "Average Monthly\nTemperature (F):",
       title = "Bird Observations vs. Average Monthly Temperature (F)",
       subtitle = "2010 - 2020")


# presence count by temperature
ggplot(birdsWeather_YM, aes(x = AvgMonthlyTemp_Statewide,
                            y = presence_count)) + 
  geom_point(aes(color = factor(Month))) + 
  geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(vars(common_name)) + 
  labs(y = "Number of Times Bird Appeared in a Checklist",
       x = "Average Temperature (F), Statewide") 

# same as above, using observations per minute instead
ggplot(birdsWeather_YM_OPM, aes(x = AvgMonthlyTemp_Statewide,
                            y = observation_per_min_avg)) + 
  geom_point(aes(color = factor(Month))) + 
  geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(vars(common_name)) + 
  labs(y = "Average Observations per Minute of Observation (log10)",
       x = "Average Temperature (F), Statewide") +
  scale_y_log10()

### presence count by temperature, visualized by month
ggplot(birdsWeather_YM, aes(x = AvgMonthlyTemp_Statewide,
                            y = presence_count,
                            color = common_name)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(vars(Month),
             scales = "free") + 
  labs(y = "Number of Times Bird Appeared in a Checklist",
       x = "Average Temperature (F), Statewide") 

# interpretation of plot: 
# In years where average temperatures in June were higher, the bird species of interest appeared on June checklists fewer times (strongest for osprey and RWBB). Compare to October: where years in which October had higher temperatures appear to correspond to more observations of all three bird species in October. This potential trend is less pronounced in summer (july, august) and winter (december).

# potential complications:
# the months with higher temperatures may also have happened to be months in the earlier or later time period of study. If this is the case, it would complicate results as there were more birders submitting observations over time - i.e. later years are likely to have more observations of all three bird species.

### plot as above (presence count by temperature, visualized by month) with observations per minute
ggplot(birdsWeather_YM_OPM, aes(x = AvgMonthlyTemp_Statewide,
                            y = log10(observation_per_min_avg),
                            color = common_name)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(vars(Month),
             scales = "free") + 
  labs(y = "Average Observations per Minute of Observation (log10)",
       x = "Average Temperature (F), Statewide") 

# In this plot, I've controlled for the skew introduced by more eBird observations being made in the later half of the study period. In April, we see that Wood Ducks (but not the other species) declined in observations (relative to effort) in years where April was warmer. Conversely, more Wood Ducks were observed (per minute of observation) in June during years with warmer June temperatures.

```

> Question: Do the average monthly observations per minute for either Osprey, Red Winged Blackbird, or Wood Duck change with average monthly temperature between 2010 and 2019?

> Does the relationship between average monthly temperature and bird observations (per minute) change depending on month? That is, does temperature have a stronger effect on bird populations in particular months?

> Hypothesis: warmer temperatures will result in less birds, effect of temperature will depend on month. 

```{r Statistical Analyses - Linear Regressions}

##### Correlation Plots #################
cor.test(birdsWeather_YM_OPM$Year, birdsWeather_YM_OPM$AvgMonthlyTemp_Statewide)
# No...

#### correlation plots!
## Osprey
ospreyOnly <- birdsWeather_YM_OPM %>%
                          # filter to bird of interest
                          filter(common_name == "Osprey")
# exclude non-numeric columns with [,4:9]
corMatrix_osprey <- cor(ospreyOnly[,4:9])
corrplot(corMatrix_osprey, method = "color")


## Red winged Blackbird 
rwbbOnly <- birdsWeather_YM_OPM %>% 
                          filter(common_name == "Red-winged Blackbird")
corMatrix_rwbb <- cor(rwbbOnly[,4:9])
corrplot(corMatrix_rwbb, method = "color")


## Wood Duck
woodduckOnly <- birdsWeather_YM_OPM %>% 
                          filter(common_name == "Wood Duck")
corMatrix_woodduck <- cor(woodduckOnly[,4:9])
corrplot(corMatrix_woodduck, method = "color")


##### Linear Regression: #########################

### Osprey ###########
# Observations per minute vs. Temperature, Year, and Month
# as an lm()
lm_osprey <- lm(data = birdsWeather_YM_OPM %>% filter(common_name == "Osprey"),
                observation_per_min_avg ~ AvgMonthlyTemp_Statewide + 
                  # have to convert month and year to factors - I think?
                  as.factor(Year) + as.factor(Month))
# summarize output
summary(lm_osprey)
# stepwise selection of most parsimonious model
step(lm_osprey)

# as an aov()
aov_osprey <- aov(data = birdsWeather_YM_OPM %>% filter(common_name == "Osprey"),
                observation_per_min_avg ~ 
                  as.factor(Year) + as.factor(Month))

summary(aov_osprey)

# post analysis Tukey Test, only run with categorical explanatory variables.
# this post analysis test will reveal which groups of years and/or 
# months had similar observations of birds
TukeyHSD(aov_osprey)

# create and print group labels - for Month
osprey.groups.yr <- 
  HSD.test(aov_osprey, "as.factor(Year)", group = TRUE)
osprey.groups.yr

# create and print group labels - for Year
osprey.groups.month <- 
  HSD.test(aov_osprey, "as.factor(Month)", group = TRUE)
osprey.groups.month


### Red winged Blackbird ###########
lm_rwbb <- lm(data = birdsWeather_YM_OPM %>% filter(common_name == "Red-winged Blackbird"),
                observation_per_min_avg ~ AvgMonthlyTemp_Statewide + as.factor(Year) + as.factor(Month))

summary(lm_rwbb)

step(lm_rwbb)

# stepwise selection suggests a model with only month is the most parsimonious 
lm_rwbb_monthOnly <- lm(data = birdsWeather_YM_OPM %>% filter(common_name == "Red-winged Blackbird"),
                observation_per_min_avg ~ as.factor(Month))

summary(lm_rwbb_monthOnly)

# run as AOV
aov_rwbb <- aov(data = birdsWeather_YM_OPM %>% filter(common_name == "Red-winged Blackbird"),
                observation_per_min_avg ~ as.factor(Month))

summary(aov_rwbb)

# post analysis Tukey Test, only run with categorical explanatory variables.
# this post analysis test will reveal which groups of years and/or 
# months had similar observations of birds
TukeyHSD(aov_rwbb)

# create and print group labels - for Month
rwbb.groups.month <- 
  HSD.test(aov_osprey, "as.factor(Month)", group = TRUE)
rwbb.groups.month

### Wood Duck ###########
lm_duck <- lm(data = birdsWeather_YM_OPM %>% filter(common_name == "Wood Duck"),
                observation_per_min_avg ~ AvgMonthlyTemp_Statewide + Year + Month)

summary(lm_duck)

step(lm_duck)
# stepwise selection indicates no variables should be removed from model
# No Tukey HSD is run for this model because it includes a continuous numerical variable (Temperature)


```

> Draft Written Summary/Notes about Linear regressions:

> Osprey: The most parisimonious model for the Osprey observations (corrected for effort) included year and month as explanatory variables, but not temperature. This model explained *68%* of the variation in Osprey observations. Like the Blackbird, the spring and summar months had similar observations (Group ab: April, May, June, August) which were statistically different than the mean of observations in fall and winter months (Group cd: September, October, November, December). 

> Red-Winged Blackbird: The most parisimonious model for the Blackbird observations (corrected for effort) included only month as an explanatory variable. This model explained only 18.9% of the variation in Blackbird observations. Like the Osprey, the spring and summar months had similar observations of Blackbird (Group ab: April, May, June, August) which were statistically different than the mean of observations in fall and winter months (Group cd: September, October, November, December). 

> Wood Duck: The most parisimonious model for the Wood Duck observations (corrected for effort) included temperature, year and month as explanatory variables. Together, these variables explain only 5.6% of the variation in wood duck observations. For every 1 degree *increase* in temperature (with month and year held constant) we would expect the observations of wood ducks (per minute of observation) to *decrease* by .00072 duck per minute observation. There is likely some other variable, not measured here, explaining the variation in wood duck observations in North Carolina between 2010 and 2020.

> Overall, the Wood Duck appears to be the only bird of the three examined in this study for which average monthly temperature has a statistically significant relationship with bird abundance (corrected for observation effort). The Month of the Year was included in the final model for all three birds, and observations tended to be most similar in non-migratory periods (namely late spring to summer and late fall to winter).


### Analysis: Date of First and Last Annual Observations
```{r create table to examine arrival and departure dates}

# start with raw data: allBirds
allBirds_FirstLast <- 
  allBirds %>% 
  # group by species, year
  group_by(common_name, year(Year_Month)) %>%
  # first is the earliest date bird is observed
  summarize(first_date = min(observation_date),
            # last date is latest 
            last_date = max(observation_date)) %>% 
  rename("Year" = "year(Year_Month)") %>% 
  mutate(first_DayOfYear = strftime(first_date, format = "%j"),
         last_DayOfYear = strftime(last_date, format = "%j"))

# pivot longer to plot both first and last date
allBirds_FirstLast_piv <- pivot_longer(allBirds_FirstLast,
                                   cols = c("first_date", "last_date"),
                                   names_to = "first_or_last",
                                   values_to = "date"
                                   ) %>% 
  mutate(Day = day(date),
         DayOfYear = strftime(date, format = "%j") )


```

```{r Plot first and last observation dates}

# plot with unpivoted data
ggplot(allBirds_FirstLast, aes(x = Year, y = date)) + 
  geom_point() + 
  geom_line(aes()) + 
  facet_wrap(vars(common_name))


# plot with pivot data
ggplot(allBirds_FirstLast_piv, aes(x = Year, y = DayOfYear, color = first_or_last)) + 
  geom_point() + 
#  geom_line() + 
  facet_wrap(vars(common_name))

# plot with pivot data, day
ggplot(allBirds_FirstLast_piv, aes(x = Year, y = Day, color = first_or_last)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(vars(common_name))



```

```{r}

```



# color reference

```{r color ref, eval=FALSE, include=FALSE}

# R Brewer Reference
display.brewer.all()

# Colormap
scales::show_col(colormap(colormap = colormaps$temperature))


```






