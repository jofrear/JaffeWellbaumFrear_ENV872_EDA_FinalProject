---
title: "Massachusetts_Cleaning_Data.Rmd"
author: "Emma Wellbaum"
date: "4/17/2021"
output: html_document
---
###
This file is for taking the downloaded ebird data and processing it into summary files. 

NOTE:

I will use 4-letter AOU Bird Codes to refer to species in R. For reference:

Red-winged Blackbird = RWBL
Osprey = OSPR
Wood Duck = WODU

(https://www.birdpop.org/pages/birdSpeciesCodes.php)

## Set up

```{r setup}
getwd()

#install.packages("auk")
library(auk)
library(tidyr)
library(dplyr)
library(lubridate)
library(ggplot2)

```

## Summarize State Temperature Data

```{r}
# Import state temperature data, downloaded from the National Atmospheric and
# Oceanic Administration using the rnoaa package
MA_temp <- read.csv('./Data/Raw/Massachusetts/MassTemperature20102021.csv') %>% unique()

# Summarize monthly temperature data for the entire state
MA_temp_state <- MA_temp %>%
  mutate(Month_Year = paste0(Month,'-',Year)) %>% 
  mutate(Month_Year = my(Month_Year)) %>%
  drop_na(AvgMonthlyTemp) %>% 
  group_by(Month_Year) %>% 
  summarize(AvgMonthlyTemp_F = mean(AvgMonthlyTemp))
```

## Osprey (OSPR)

```{r echo=FALSE}
# Import data downloaded from eBird and filter for columns and rows of interest
OSPR_MA_ebd <- read_ebd(
  "./Data/Raw/Massachusetts/ebd_US-MA_osprey_relFeb-2021/ebd_US-MA_osprey_relFeb-2021.txt") %>%
  select(common_name:observation_count, state, county, latitude:observation_date, protocol_type,duration_minutes:all_species_reported) %>% 
  mutate(Month = month(observation_date),
         Year = year(observation_date)) %>% 
  mutate(Month_Year = floor_date(observation_date, unit = "month")) %>% 
  filter(year(observation_date) %in% c(2010:2021)) %>%
  arrange(Month_Year)

#Convert "presence" notations (symbolized with an "X") to observations of 1 bird
OSPR_MA_ebd$observation_count[OSPR_MA_ebd$observation_count == "X"] <- 1
OSPR_MA_ebd$observation_count <- as.integer(OSPR_MA_ebd$observation_count)

#Join monthly temperature data to bird observation data
OSPR_MA_ebd <- merge(x=OSPR_MA_ebd, y=MA_temp_state, by='Month_Year', all.x=TRUE)

#Create a summary dataframe for the number of observations in each month
OSPR_MA_month <- OSPR_MA_ebd %>% 
  group_by(Month_Year) %>% 
  summarize(Observations = sum(observation_count),
            AvgMonthlyTemp_F = first(AvgMonthlyTemp_F)) %>% 
  mutate(Common_Name = "Osprey",
         State = "Massachusetts") %>% 
  select(Common_Name, State, Observations, Month_Year, AvgMonthlyTemp_F)

# Create a summary dataframe of first and last observation dates per year
OSPR_MA_firstlast <- OSPR_MA_ebd %>% 
  group_by(year(Month_Year)) %>% 
  summarize(First_Observation = min(observation_date),
            Last_Observation = max(observation_date),
            AvgAnnualTemp_F = mean(AvgMonthlyTemp_F)) %>% 
  rename(Year = "year(Month_Year)") %>% 
  mutate(Common_Name = "Osprey",
         State = "Massachusetts") %>% 
  select(Common_Name, State, Year, First_Observation, Last_Observation, AvgAnnualTemp_F)
```

## Red-Winged Blackbird (RWBL)
```{r}
# Import data downloaded from eBird and filter for columns and rows of interest
RWBL_MA_ebd <- read_ebd(
  "./Data/Raw/Massachusetts/ebd_US-MA_rewbla_201001_202102_relMar-2021/ebd_US-MA_rewbla_201001_202102_relMar-2021.txt") %>%
  select(common_name:observation_count, state, county, latitude:observation_date, protocol_type,duration_minutes:all_species_reported) %>% 
  mutate(Month_Year = floor_date(observation_date, unit = "month")) %>% 
  filter(year(observation_date) %in% c(2010:2021)) %>%
  arrange(Month_Year)

#Convert "presence" notations (symbolized with an "X") to observations of 1 bird
RWBL_MA_ebd$observation_count[RWBL_MA_ebd$observation_count == "X"] <- 1
RWBL_MA_ebd$observation_count <- as.integer(RWBL_MA_ebd$observation_count)

#Join monthly temperature data to bird observation data
RWBL_MA_ebd <- merge(x=RWBL_MA_ebd, y=MA_temp_state, by='Month_Year', all.x=TRUE)

#Create a summary dataframe for the number of observations in each month
RWBL_MA_month <- RWBL_MA_ebd %>% 
  group_by(Month_Year) %>% 
  summarize(Observations = sum(observation_count),
            AvgMonthlyTemp_F = first(AvgMonthlyTemp_F)) %>% 
  mutate(Common_Name = "Red-Winged Blackbird",
         State = "Massachusetts") %>% 
  select(Common_Name, State, Observations, Month_Year, AvgMonthlyTemp_F)

# Create a summary dataframe of first and last observation dates per year
RWBL_MA_firstlast <- RWBL_MA_ebd %>% 
  group_by(year(Month_Year)) %>% 
  summarize(First_Observation = min(observation_date),
            Last_Observation = max(observation_date),
            AvgAnnualTemp_F = mean(AvgMonthlyTemp_F)) %>% 
  rename(Year = "year(Month_Year)") %>% 
  mutate(Common_Name = "Red-Winged Blackbird",
         State = "Massachusetts") %>% 
  select(Common_Name, State, Year, First_Observation, Last_Observation, AvgAnnualTemp_F)
```

## Wood Duck (WODU)
```{r}
# Import data downloaded from eBird and filter for columns and rows of interest
WODU_MA_ebd <- read_ebd(
  "./Data/Raw/Massachusetts/ebd_US-MA_wooduc_relFeb-2021/ebd_US-MA_wooduc_relFeb-2021.txt") %>%
  select(common_name:observation_count, state, county, latitude:observation_date, protocol_type,duration_minutes:all_species_reported) %>% 
  mutate(Month_Year = floor_date(observation_date, unit = "month")) %>% 
  filter(year(observation_date) %in% c(2010:2021)) %>%
  arrange(Month_Year)

#Convert "presence" notations (symbolized with an "X") to observations of 1 bird
WODU_MA_ebd$observation_count[WODU_MA_ebd$observation_count == "X"] <- 1
WODU_MA_ebd$observation_count <- as.integer(WODU_MA_ebd$observation_count)

#Join monthly temperature data to bird observation data
WODU_MA_ebd <- merge(x=WODU_MA_ebd, y=MA_temp_state, by='Month_Year', all.x=TRUE)

#Create a summary dataframe for the number of observations in each month
WODU_MA_month <- WODU_MA_ebd %>% 
  group_by(Month_Year) %>% 
  summarize(Observations = sum(observation_count),
            AvgMonthlyTemp_F = first(AvgMonthlyTemp_F)) %>% 
  mutate(Common_Name = "Wood Duck",
         State = "Massachusetts") %>% 
  select(Common_Name, State, Observations, Month_Year, AvgMonthlyTemp_F)

# Create a summary dataframe of first and last observation dates per year
WODU_MA_firstlast <- WODU_MA_ebd %>% 
  group_by(year(Month_Year)) %>% 
  summarize(First_Observation = min(observation_date),
            Last_Observation = max(observation_date),
            AvgAnnualTemp_F = mean(AvgMonthlyTemp_F)) %>% 
  rename(Year = "year(Month_Year)") %>% 
  mutate(Common_Name = "Wood Duck",
         State = "Massachusetts") %>% 
  select(Common_Name, State, Year, First_Observation, Last_Observation, AvgAnnualTemp_F)
```

## Plot results
```{r}
OspreyPlot <- ggplot(OSPR_MA_month, aes(x=Month_Year, y=Observations, color=AvgMonthlyTemp_F)) +
  geom_line()

OspreyPlot
```

