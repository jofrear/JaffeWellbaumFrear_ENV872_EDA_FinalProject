---
title: "Maine_Cleaning_Data"
author: "Joshua Frear"
date: "4/15/2021"
output: html_document
---
###
This file is for taking the downloaded ebird data and processing it into summary files. 

NOTE:

I will use 4-letter AOU Bird Codes to refer to species in R. For reference:

Red-winged Blackbird = RWBL
Osprey = OSPR
Wood Duck = WODU

(https://www.birdpop.org/pages/birdSpeciesCodes.php)

```{r Load.and.Tidy.Data}
#install.packages("auk")
library(auk)
library(tidyr)
library(dplyr)
library(lubridate)
library(ggplot2)

getwd()

#Import datasets, obtained from Ebird through a request on the website. 
WODU_ME_ebd <- read_ebd("../Data/Raw/Maine/ebd_US-ME_wooduc_relFeb-2021/ebd_US-ME_wooduc_relFeb-2021.txt")
RWBL_ME_ebd <- read_ebd("../Data/Raw/Maine/ebd_US-ME_rewbla_relFeb-2021/ebd_US-ME_rewbla_relFeb-2021.txt")
OSPR_ME_ebd <- read_ebd("../Data/Raw/Maine/ebd_US-ME_osprey_relFeb-2021/ebd_US-ME_osprey_relFeb-2021.txt")

### Osprey ###

#Remove columns that are not of interest
#For the initial clean, I'm keeping variables related to effort
OSPR_ME_ebd <- OSPR_ME_ebd %>% 
  select(common_name:observation_count, state, county, latitude:observation_date, protocol_type,duration_minutes:all_species_reported) 

#Ebird allows "presence" notations in counts with the character "X"
#For our project, we will consider that as an observation of 1 bird.
OSPR_ME_ebd$observation_count[OSPR_ME_ebd$observation_count == "X"] <- 1
OSPR_ME_ebd$observation_count <- as.integer(OSPR_ME_ebd$observation_count)

#Create column for year to remove old observations
OSPR_ME_ebd$Year <- year(OSPR_ME_ebd$observation_date)
#unique(OSPR_ME_ebd$Year)
#Observations from before 2010 are included, so filter them out
OSPR_ME_ebd <- OSPR_ME_ebd %>% filter(Year >= 2010)

#Turn observation date into a month-year by using floor_date()
OSPR_ME_ebd$Month_Year <- floor_date(OSPR_ME_ebd$observation_date, unit = "month")

#Create a summary dataframe with one row for the sum of birds seen in a given month-year
#IE 25 Ospreys observed in February 2016
OSPR_ME_month <- OSPR_ME_ebd %>% 
  group_by(Month_Year) %>% 
  dplyr::summarize(sum(observation_count)) %>% 
  rename("Observations" = "sum(observation_count)") %>% 
  mutate(Common_Name = "Osprey",
         State = "Maine")

plot1 <- ggplot(OSPR_ME_month, aes(x = Month_Year, y = Observations)) + geom_line() + 
  geom_smooth(method = "loess", se = F)
print(plot1)

### Wood Duck ###

#Remove columns that are not of interest
WODU_ME_ebd <- WODU_ME_ebd %>% 
  select(common_name:observation_count, state, county, latitude:observation_date, protocol_type,duration_minutes:all_species_reported) 

#Ebird allows "presence" notations in counts with the character "X"
#For our project, we will consider that as an observation of 1 bird.
WODU_ME_ebd$observation_count[WODU_ME_ebd$observation_count == "X"] <- 1
WODU_ME_ebd$observation_count <- as.integer(WODU_ME_ebd$observation_count)

#Create column for year to remove old observations
WODU_ME_ebd$Year <- year(WODU_ME_ebd$observation_date)
#unique(WODU_ME_ebd$Year)
#Observations from before 2010 are included, so filter them out
WODU_ME_ebd <- WODU_ME_ebd %>% filter(Year >= 2010)

#Turn observation date into a month-year by using floor_date()
WODU_ME_ebd$Month_Year <- floor_date(WODU_ME_ebd$observation_date, unit = "month")

#Create a summary dataframe with one row for the sum of birds seen in a given month-year
WODU_ME_month <- WODU_ME_ebd %>% 
  group_by(Month_Year) %>% 
  dplyr::summarize(sum(observation_count)) %>% 
  rename("Observations" = "sum(observation_count)") %>% 
  mutate(Common_Name = "Wood Duck",
         State = "Maine")

plot2 <- ggplot(WODU_ME_month, aes(x = Month_Year, y = Observations)) + geom_line() + 
  geom_smooth(method = "loess", se = F)
print(plot2)

### Red-Winged Blackbird ###

#Remove columns that are not of interest
#For the initial clean, I'm keeping variables related to effort
RWBL_ME_ebd <- RWBL_ME_ebd %>% 
  select(common_name:observation_count, state, county, latitude:observation_date, protocol_type,duration_minutes:all_species_reported) 

#Ebird allows "presence" notations in counts with the character "X"
#For our project, we will consider that as an observation of 1 bird.
RWBL_ME_ebd$observation_count[RWBL_ME_ebd$observation_count == "X"] <- 1
RWBL_ME_ebd$observation_count <- as.integer(RWBL_ME_ebd$observation_count)

#Create column for year to remove old observations
RWBL_ME_ebd$Year <- year(RWBL_ME_ebd$observation_date)
#unique(RWBL_ME_ebd$Year)
#Observations from before 2010 are included, so filter them out
RWBL_ME_ebd <- RWBL_ME_ebd %>% filter(Year >= 2010)

#Turn observation date into a month-year by using floor_date()
RWBL_ME_ebd$Month_Year <- floor_date(RWBL_ME_ebd$observation_date, unit = "month")

#Create a summary dataframe with one row for the sum of birds seen in a given month-year
RWBL_ME_month <- RWBL_ME_ebd %>% 
  group_by(Month_Year) %>% 
  dplyr::summarize(sum(observation_count)) %>% 
  rename("Observations" = "sum(observation_count)") %>% 
  mutate(Common_Name = "Red-Winged Blackbird",
         State = "Maine")

plot3 <- ggplot(RWBL_ME_month, aes(x = Month_Year, y = Observations)) + geom_line() + 
  geom_smooth(method = "loess", se = F)
print(plot3)
#ggsave("RWBL_ME_month.png")

```

```{r Add.Temperature.Data}

Maine_Temps <- read.csv("../Data/Raw/Maine/MaineTemperature20102021.csv")
Maine_Temps <- Maine_Temps[!duplicated(Maine_Temps), ]

Maine_Temps$Month_Year <- paste0(Maine_Temps$Month,"-",Maine_Temps$Year)
Maine_Temps$Month_Year <- my(Maine_Temps$Month_Year)

Maine_Temps_Statewide <- Maine_Temps %>% drop_na() %>% 
  group_by(Month_Year) %>% 
   dplyr::summarize(mean(AvgMonthlyTemp)) %>% 
  rename("Mean_Temperature" = "mean(AvgMonthlyTemp)")

RWBL_ME_month <- full_join(Maine_Temps_Statewide, RWBL_ME_month, by = "Month_Year")
OSPR_ME_month <- full_join(Maine_Temps_Statewide, OSPR_ME_month, by = "Month_Year")
WODU_ME_month <- full_join(Maine_Temps_Statewide, WODU_ME_month, by = "Month_Year")

plot4 <- ggplot(RWBL_ME_month, aes(x = Month_Year, y = Observations, color = Mean_Temperature)) + 
  geom_point()
  
print(plot4)

#write summary csv files to project folder
write.csv(OSPR_ME_month, file = "../Data/Processed/Maine/OSPR_ME_month.csv")
write.csv(WODU_ME_month, file = "../Data/Processed/Maine/WODU_ME_month.csv")
write.csv(RWBL_ME_month, file = "../Data/Processed/Maine/RWBL_ME_month.csv")
```

```{r Find.First.Last.Obs.Dates}

#use min and max

OSPR_ME_dates <- OSPR_ME_ebd %>% 
  group_by(year(Month_Year)) %>% 
  summarize(FirstObs = min(observation_date), LastObs = max(observation_date))

WODU_ME_dates <- WODU_ME_ebd %>% 
  group_by(year(Month_Year)) %>% 
  summarize(FirstObs = min(observation_date), LastObs = max(observation_date))

RWBL_ME_dates <- RWBL_ME_ebd %>% 
  group_by(year(Month_Year)) %>% 
  summarize(FirstObs = min(observation_date), LastObs = max(observation_date))

#write summary csv files to project folder
write.csv(OSPR_ME_dates, file = "../Data/Processed/Maine/OSPR_ME_firstlast.csv")
write.csv(WODU_ME_dates, file = "../Data/Processed/Maine/WODU_ME_firstlast.csv")
write.csv(RWBL_ME_dates, file = "../Data/Processed/Maine/RWBL_ME_firstlast.csv")

```

```{r Merge.Species}

allBirds <- bind_rows(RWBL_ME_ebd, OSPR_ME_ebd, WODU_ME_ebd)

allBirds <- allBirds %>% 
  mutate(observations_per_min = observation_count/duration_minutes,
         Week = week(observation_date), 
         Presence = 1)

summary(allBirds$observations_per_min)



allBirds_obvPerMin <- allBirds %>% 
  filter( is.na(observations_per_min) == FALSE) %>% 
  filter( observations_per_min != Inf)

summary(allBirds_obvPerMin$observations_per_min)

allBirds_MYgrouped <- 
  allBirds %>%
  group_by(common_name, Month_Year) %>% 
  summarize(state = first(state),
            observation_count_sum = sum(observation_count),
            presence_count = sum(Presence)
            ) 
# observations per minute (OPM)
allBirds_MYgrouped_OPM <- 
  allBirds_obvPerMin %>%
  group_by(common_name, Month_Year) %>% 
  summarize(state = first(state),
            observation_count_sum = sum(observation_count),
            presence_count = sum(Presence),
            observation_per_min_avg = mean(observations_per_min)
            ) 

#Observations, corrected for effort
#Observations / Effort

allBirds_WeekGrouped <- allBirds %>%
  group_by(common_name, Week) %>% 
  summarize(state = first(state),
            observation_count_sum = sum(observation_count),
            presence_count = sum(Presence)
            ) 
plotweek <- ggplot(allBirds_WeekGrouped, aes(x = Week, y = presence_count)) + geom_point(aes(color = common_name))
print(plotweek)


```